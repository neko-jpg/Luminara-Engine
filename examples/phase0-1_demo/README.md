# 🎮 Luminara Engine - Ultimate Demo

## 究極のデモ：物理シミュレーションとインタラクティブコントロール

このデモは、Luminara Engineの全機能を統合した包括的なショーケースです。

---

## 🚀 実行方法

### Windows + WSL (推奨)

#### 方法1: インタラクティブメニュー (最も簡単)
```cmd
cd examples\ultimate_demo
menu.bat
```

メニューから以下のオプションを選択できます：
- [1] デモ実行 (Release)
- [2] デモ実行 (Debug)
- [3] ビルドのみ (Release)
- [4] ビルドのみ (Debug)
- [5] クリーンビルド
- [6] 依存関係チェック
- [7] ログ表示
- [8] テスト実行
- [9] コントロールヘルプ

#### 方法2: 直接実行
```cmd
cd examples\ultimate_demo
run_wsl.bat
```

#### 方法3: WSLコマンド直接実行
```cmd
wsl -d ubuntu bash -c "cd /mnt/c/dev/Luminara-Engine/examples/ultimate_demo && /home/arat2/.cargo/bin/cargo run --release"
```

### Linux / WSL内部
```bash
cd examples/ultimate_demo
cargo run --release
```

---

## � デモ内コントロール

### カメラ操作
- **W/A/S/D**: 前進/左/後退/右
- **マウス**: 視点移動 (FPS スタイル)
- **Shift**: スプリントモード (3倍速)
- **Space**: 上昇
- **Ctrl**: 下降

### デモ機能
- **G**: デバッグギズモの表示/非表示
- **P**: 物理シミュレーションの一時停止/再開
- **T**: カメラ位置にランダムなオブジェクトを生成
- **1-5**: 特定の形状を生成（球体/立方体/発光体/スタック/レイン）
- **C**: 動的に生成されたオブジェクトをクリア
- **R**: カメラ位置をリセット
- **F**: ターゲットシューティングモードの切り替え
- **Y**: ターゲットを生成
- **E**: カメラ位置で爆発を発生
- **V**: 重力方向を循環（下/右/上/左）
- **+/-**: 重力スケールを増減
- **B**: スローモーション切り替え（0.25x）
- **7**: ブルームエフェクトの切り替え
- **8**: 被写界深度（DOF）の切り替え
- **[/]**: 露出調整
- **,/.**: 前/次のシーンに切り替え
- **H**: コマンドメニューの表示/非表示

### システム
- **Esc**: デモ終了

---

## 📊 デモの特徴

### Phase 1 Enhancements 実装済み機能

#### 入力システム強化
- **マウススムージング**: EMA (指数移動平均) によるジッター除去
- **FOV連動感度**: ズームレベルに応じた一貫した操作感
- **アクション抽象化**: 物理デバイスから独立した論理アクション
- **カーソルロック改善**: フォーカス遷移時の安定した動作

#### インタラクティブ物理
- **マウスグラブ**: オブジェクトを掴んで投げる
  - スプリング制約による自然な動き
  - 速度履歴に基づく投擲力計算
  - レイキャストによる正確な選択
- **爆発システム**: 半径ベースの力場
- **ターゲットゲーム**: スコアリングとフィードバック

#### ビジュアル強化
- **ポストプロセッシング**: ブルーム、DOF、トーンマッピング
- **カメラシェイク**: 衝撃に応じた動的な揺れ
- **パーティクルシステム**: 噴水、炎、爆発エフェクト
- **LODシステム**: 距離に応じた詳細度調整

#### 開発者ツール
- **インゲームコンソール**: ランタイムパラメータ調整
  - 重力、タイムスケール、スポーン制御
  - コマンド履歴とオートコンプリート
  - カスタムコマンド登録可能
- **デバッグギズモ**: 7カテゴリの可視化
- **パフォーマンス統計**: FPS、P99フレームタイム

### シーン構成

このデモには3つのシーンが含まれています：

1. **Physics Lab（物理実験室）** - デフォルトシーン
   - 球体タワー（左側）: 15個の金属球が積み重なったタワー - 劇的に崩壊します
   - 立方体ピラミッド（中央）: 30個の立方体で構成されたピラミッド
   - 発光球体（周囲）: 6個の光るエネルギーコアが円形に配置
   - 装飾アーチ: 5箇所の石造りアーチ
   - コーナーピラー: 4つの装飾的な柱
   - 地面と壁: 物理シミュレーションの境界
   - 動的照明: リアルタイムシャドウ付きの指向性ライト + 8つのアクセントライト

2. **Chaos Arena（カオスアリーナ）** - キー: . で切り替え
   - 高エネルギーな環境
   - 赤と青のアクセントライト
   - 爆発とパーティクルに最適化

3. **Target Range（射撃場）** - キー: , で切り替え
   - 射撃練習用シーン
   - ターゲット配置に最適化
   - 金色のアクセントライト

### 視覚機能

- **PBRマテリアル**: 各オブジェクトは独自のメタリック/ラフネス値を持つ
  - コンクリートテクスチャ（地面）
  - 金属テクスチャ（球体）
  - ノーマルマップとラフネスマップ
- **リアルタイムシャドウ**: 指向性ライトが動的な影を投影
- **ポストプロセッシング**:
  - ブルーム（光の滲み）- キー: 7
  - 被写界深度（DOF）- キー: 8
  - トーンマッピングと露出調整 - キー: [/]
  - ビネット効果
- **パーティクルシステム**:
  - 中央噴水
  - 4つのファイアジェット
  - 爆発エフェクト
  - ヒットエフェクト
- **アニメーション**:
  - エネルギーコアの回転と浮遊
  - 時間ベースのアニメーション
- **デバッグ可視化**: ギズモで物理エンジンの内部を表示
  - 速度ベクトル（緑の線）
  - 衝突法線（赤の線）
  - BVHバウンディングボックス（シアンのワイヤーフレーム）
  - ローカル座標軸（RGB = XYZ）
  - グリッドとワールド軸
- **LODシステム**: 距離に応じた詳細度の自動調整
- **スムーズカメラ**: 慣性ベースの移動とスプリングダンパー補間
- **パフォーマンス統計**: リアルタイムFPS、平均FPS、P99フレームタイム、エンティティ数

---

## 🎯 デモの見どころ

### 物理カオス
1. **初期崩壊**: 球体タワーが最初に崩れ、連鎖反応を引き起こす
2. **ピラミッド破壊**: 立方体が転がり落ちる
3. **創発的挙動**: オブジェクトが予測不可能な方法で相互作用
4. **安定した静止**: 最終的にすべてが安定した構成に落ち着く
5. **重力実験**: 重力方向を変更して異なる挙動を観察
6. **爆発物理**: 爆発の衝撃波がオブジェクトを吹き飛ばす

### インタラクティブ機能
- **動的生成**: Tキーでランダムなオブジェクトを生成
- **形状選択**: 1-5キーで特定の形状を生成
- **スタック構築**: 4キーで5個の立方体スタックを生成
- **レイン**: 5キーで10個の球体を降らせる
- **爆発**: Eキーでカメラ位置に爆発を発生
- **ターゲット射撃**: Fキーでターゲットモードを有効化し、LMBで射撃
- **重力制御**: Vキーで重力方向を循環、+/-で強度調整
- **時間制御**: Bキーでスローモーション（0.25x速度）
- **マウス操作**: LMBでオブジェクトを掴んで投げる
  - スプリング制約による自然な動き
  - マウス速度に基づく投擲力
  - 動的オブジェクトのみ操作可能

### ビジュアルエフェクト
- **ポストプロセッシング**: 7/8キーでブルームとDOFを切り替え
- **露出調整**: [/]キーで明るさを調整
- **パーティクル**: 噴水、ファイア、爆発、ヒットエフェクト
- **アニメーション**: エネルギーコアの回転と浮遊
- **ライティング**: 複数のカラーライトによる雰囲気作り

### デバッグ可視化 (Gキーを押す)
- **緑の速度ベクトル**: オブジェクトの移動方向と速度を表示
- **赤の衝突法線**: 接触点に表示
- **シアンのBVHボックス**: 空間加速構造を表示
- **RGB軸**: 各オブジェクトのローカル座標系を示す
- **グリッド**: ワールド空間のグリッド表示
- **カテゴリ別表示**: 7つのカテゴリを循環表示

### パフォーマンス最適化
- **LODシステム**: 遠くのオブジェクトの詳細度を自動調整
- **効率的なクエリ**: ECSアーキテクチャによる高速処理
- **プロファイリング**: リアルタイムFPS、平均FPS、P99フレームタイム表示

---

## � カスタマイズ

### オブジェクトを追加生成
Tキーを押してカメラ位置にオブジェクトを生成。試してみてください：
- 異なる高さに飛んで生成
- 移動中に生成
- タワーや構造物を作成

### 物理パラメータの変更
`src/main.rs`を編集して以下を変更：
- 重力の強さ
- オブジェクトの質量
- マテリアルプロパティ (摩擦、反発)
- 生成パターン

### ビジュアルの調整
以下を調整：
- PBRマテリアル値 (メタリック、ラフネス)
- ライトの強度と色
- シャドウ品質
- カメラFOVと速度

---

## � パフォーマンス指標

中程度のシステム (Ryzen 5 3600, GTX 1660) での測定値：
- **フレームタイム**: ~16ms (60 FPS)
- **物理ステップ**: ~2ms
- **レンダリング時間**: ~12ms
- **ギズモレンダリング**: ~1ms (有効時)
- **メモリ使用量**: ~200MB

---

## � トラブルシューティング

### WSL関連

#### WSLが見つからない
```cmd
# WSLのインストール状態を確認
wsl -l -v

# Ubuntuがない場合はインストール
wsl --install -d Ubuntu
```

#### Cargoが見つからない
```bash
# WSL内でRustをインストール
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
source $HOME/.cargo/env
```

#### パスが正しくない
```cmd
# プロジェクトパスを確認
wsl -d ubuntu bash -c "ls /mnt/c/dev/Luminara-Engine/examples/ultimate_demo"

# Cargoパスを確認
wsl -d ubuntu bash -c "ls /home/arat2/.cargo/bin/cargo"
```

### パフォーマンス関連

#### FPSが低い
- ギズモを無効化 (Gキーを押す)
- 設定でシャドウ品質を下げる
- Releaseモードで実行 (`--release`)

#### 物理が不安定
- 生成レートを下げる
- 物理サブステップを増やす
- トランスフォームのNaN値をチェック

#### レンダリングの問題
- グラフィックドライバを更新
- wgpuバックエンドを確認 (Vulkan/DX12/Metal)
- シェーダーコンパイルを検証

---

## � 技術詳細

### アーキテクチャ

このデモは以下を統合しています：

1. **ECSコア** (`luminara_core`)
   - World, Entity, Component, System
   - プラグインシステム
   - スケジューリング

2. **レンダリング** (`luminara_render`)
   - wgpuベースのモダンなグラフィックスパイプライン
   - PBRシェーディング
   - シャドウマッピング
   - メッシュとテクスチャ

3. **物理** (`luminara_physics`)
   - Rapier統合 (3D)
   - 衝突検出
   - リジッドボディダイナミクス

4. **数学** (`luminara_math`)
   - PGA (射影幾何代数)
   - モーター (回転と平行移動)
   - 正確な述語

5. **入力** (`luminara_input`)
   - キーボード、マウス
   - ゲームパッドサポート

6. **シーン** (`luminara_scene`)
   - トランスフォーム階層
   - シリアライゼーション (RON/JSON)

---

## 🎓 学習ポイント

このデモから学べること：

1. **ECSアーキテクチャ**: エンティティ、コンポーネント、システムの連携
2. **物理統合**: Rapierをエンジンに接続する方法
3. **レンダリングパイプライン**: PBRマテリアル、ライティング、シャドウ
4. **デバッグツール**: 開発者フレンドリーな可視化の構築
5. **パフォーマンス**: 60 FPSで100以上のオブジェクトを処理
6. **クロスプラットフォーム**: Windows + WSLでの開発

---

## � まとめ

このデモは、本格的なゲームエンジン基盤を表しています。見える全ての機能—ECSコアから物理シミュレーション、デバッグツールまで—は、パフォーマンス、正確性、開発者体験を念頭に置いてゼロから構築されました。

**Phase 0-1 完了。Phase 2-3 (スクリプティング、エディタ、ネットワーキング) が待っています！**

---

## 📞 サポート

問題が発生した場合：

1. `menu.bat`の「依存関係チェック」を実行
2. `error.log`を確認
3. WSLとCargoのパスを検証
4. Releaseモードでビルドを試す

---

## 📜 ライセンス

Luminara Engine の一部として提供されています。

Built with ❤️ and Rust 🦀
